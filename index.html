<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sleeper League Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-900 antialiased p-4 sm:p-6">
  <div class="max-w-3xl mx-auto">
    <header class="flex items-center gap-3 mb-4">
      <div class="w-10 h-10 rounded-md bg-black text-white flex items-center justify-center font-bold">S</div>
      <div>
        <h1 class="text-lg font-semibold">Sleeper — League Dashboard</h1>
        <div class="text-xs text-gray-500">Mobile-first, responsive. League ID: <span id="league-id"></span></div>
      </div>
    </header>

    <div id="error" class="hidden p-3 rounded bg-red-100 text-red-800"></div>
    <div id="loading" class="text-center py-10">Loading league info…</div>

    <main id="main" class="space-y-6 hidden">
      <section class="bg-gray-50 p-3 rounded">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-gray-600">League</div>
            <div id="league-name" class="font-semibold text-base"></div>
          </div>
          <div class="text-right text-xs text-gray-500">Week <span id="current-week"></span> detected</div>
        </div>
      </section>

      <section class="bg-white p-3 rounded shadow-sm">
        <h2 class="font-semibold mb-2">Teams</h2>
        <div id="teams" class="grid grid-cols-3 gap-3 sm:grid-cols-4"></div>
      </section>

      <section class="bg-white p-3 rounded shadow-sm">
        <h2 class="font-semibold mb-2">Luck Index</h2>
        <div id="luck" class="space-y-2"></div>
      </section>

      <section class="bg-white p-3 rounded shadow-sm">
        <h2 class="font-semibold mb-2">Power Rankings</h2>
        <ol id="power" class="list-decimal pl-5 space-y-2"></ol>
      </section>

      <section class="bg-white p-3 rounded shadow-sm">
        <h2 class="font-semibold mb-2">Efficiency (Offense / Defense)</h2>
        <div id="efficiency" class="space-y-2"></div>
      </section>

      <section class="bg-white p-3 rounded shadow-sm">
        <h2 class="font-semibold mb-2">Playoff Odds (Monte Carlo)</h2>
        <div class="flex gap-2 items-center mb-3">
          <label class="text-xs text-gray-600">Simulations</label>
          <input id="sim-count" type="number" value="1000" class="ml-2 w-24 p-1 rounded border text-sm" />
          <button id="run-sim" class="ml-auto px-3 py-1 rounded text-white bg-blue-600">Run Monte Carlo</button>
        </div>
        <div id="playoff-results" class="space-y-2 text-xs text-gray-500">No results yet. Click run to simulate playoff odds.</div>
      </section>

      <footer class="text-xs text-gray-400 text-center py-4">Built for mobile — optimistic styling like Sleeper. Replace LEAGUE_ID in script.</footer>
    </main>
  </div>

<script>
const LEAGUE_ID = "1257464138565689344"; // <-- Replace with your league id
const BASE = "https://api.sleeper.app/v1";

document.getElementById("league-id").textContent = LEAGUE_ID;

function initials(name) {
  return (name || "?").split(" ").map(s => s[0]).slice(0,2).join("").toUpperCase();
}

async function fetchJson(path) {
  const r = await fetch(BASE+path);
  if (!r.ok) throw new Error(r.status+" "+r.statusText);
  return r.json();
}

let league, settings, rosters, users, allMatchups = {}, teams = {}, teamStats = {}, currentWeek = 1;

async function init() {
  try {
    league = await fetchJson(`/league/${LEAGUE_ID}`);
    settings = await fetchJson(`/league/${LEAGUE_ID}/settings`);
    rosters = await fetchJson(`/league/${LEAGUE_ID}/rosters`);
    users = await fetchJson(`/league/${LEAGUE_ID}/users`);

    for (let w=1; w<=20; w++) {
      try {
        const data = await fetchJson(`/league/${LEAGUE_ID}/matchups/${w}`);
        if (data.length) allMatchups[w] = data;
      } catch(e) {}
    }

    detectCurrentWeek();
    mapTeams();
    computeStats();

    render();
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("main").classList.remove("hidden");
  } catch(e) {
    document.getElementById("error").textContent = e.message;
    document.getElementById("error").classList.remove("hidden");
  }
}

function detectCurrentWeek() {
  let detected=1;
  for (const [wk, arr] of Object.entries(allMatchups)) {
    const played = arr.some(m => m.points!==undefined || m.home_points!==undefined);
    if (played) detected=Math.max(detected, parseInt(wk));
  }
  currentWeek=detected;
}

function mapTeams() {
  teams={};
  rosters.forEach(r=>{
    const owner = users.find(u=>u.user_id===r.owner_id);
    teams[r.roster_id]={
      id:r.roster_id,
      teamName:r.metadata?.team_name || `Team ${r.roster_id}`,
      manager:owner?.display_name||"Manager",
      logo:r.metadata?.team_logo || (owner?.avatar?`https://sleepercdn.com/avatars/${owner.avatar}`:null)
    };
  });
}

function computeStats(){
  teamStats={};
  Object.values(teams).forEach(t=>teamStats[t.id]={for:0,against:0,games:0,wins:0,losses:0,scores:[]});
  for (const arr of Object.values(allMatchups)){
    arr.forEach(m=>{
      if (m.home_points!==undefined && m.away_points!==undefined){
        update(m.home_id,m.home_points,m.away_points);
        update(m.away_id,m.away_points,m.home_points);
      } else if (m.roster_id!==undefined && m.points!==undefined){
        let s=teamStats[m.roster_id];
        if(s){s.for+=m.points;s.scores.push(m.points);s.games++;}
      }
    });
  }
  function update(id,pts,opp){
    let s=teamStats[id];if(!s)return;
    s.for+=pts;s.against+=opp;s.scores.push(pts);s.games++;
    if(pts>opp)s.wins++;else if(pts<opp)s.losses++;
  }
  Object.values(teamStats).forEach(s=>{s.ppg=s.games?s.for/s.games:0;s.apg=s.games?s.against/s.games:0;s.winPct=s.games?s.wins/s.games:0});
}

function render(){
  document.getElementById("league-name").textContent=league.name;
  document.getElementById("current-week").textContent=currentWeek;

  // Teams
  const teamsDiv=document.getElementById("teams");teamsDiv.innerHTML="";
  Object.values(teams).forEach(t=>{
    let div=document.createElement("div");div.className="flex flex-col items-center text-center";
    if(t.logo){div.innerHTML=`<img src="${t.logo}" class="w-12 h-12 rounded-full object-cover mb-1"/><div class="text-xs font-medium truncate">${t.teamName}</div><div class="text-xxs text-gray-500 truncate">${t.manager}</div>`;}
    else{div.innerHTML=`<div class='w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center'>${initials(t.teamName)}</div><div class="text-xs font-medium truncate">${t.teamName}</div><div class="text-xxs text-gray-500 truncate">${t.manager}</div>`;}
    teamsDiv.appendChild(div);
  });

  // Luck
  let luckArr=[];
  Object.values(teams).forEach(t=>{
    let s=teamStats[t.id];if(!s)return;
    let exp=(Math.pow(s.for,2))/(Math.pow(s.for,2)+Math.pow(s.against,2)+0.0001)*s.games;
    let luck=(s.wins-exp).toFixed(2);
    luckArr.push({team:t,luck});
  });
  luckArr.sort((a,b)=>b.luck-a.luck);
  const luckDiv=document.getElementById("luck");luckDiv.innerHTML="";
  luckArr.forEach(l=>{
    luckDiv.innerHTML+=`<div class='flex items-center justify-between'><div><div class='text-sm font-medium'>${l.team.teamName}</div><div class='text-xs text-gray-500'>${l.team.manager}</div></div><div class='text-sm font-semibold'>${l.luck}</div></div>`;
  });

  // Power
  let pow=[];Object.values(teams).forEach(t=>{let s=teamStats[t.id];let sc=s.ppg*0.6+s.winPct*100*0.4;pow.push({team:t,score:sc.toFixed(2)})});pow.sort((a,b)=>b.score-a.score);
  const powOl=document.getElementById("power");powOl.innerHTML="";pow.forEach(p=>{powOl.innerHTML+=`<li class='flex justify-between'><span>${p.team.teamName}</span><span>${p.score}</span></li>`});

  // Efficiency
  let eff=[];Object.values(teams).forEach(t=>{let s=teamStats[t.id];eff.push({team:t,off:s.ppg.toFixed(1),def:s.apg.toFixed(1)})});eff.sort((a,b)=>b.off-a.off);
  const effDiv=document.getElementById("efficiency");effDiv.innerHTML="";eff.forEach(e=>{effDiv.innerHTML+=`<div class='flex justify-between'><span>${e.team.teamName}</span><span>${e.off} / ${e.def}</span></div>`});
}

// Monte Carlo simulation (simplified)
function gaussian(mean,std){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();return mean+std*Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);}
async function simulate(sims){
  const playoffCounts={};Object.keys(teams).forEach(id=>playoffCounts[id]=0);
  let lastWeek=Math.max(...Object.keys(allMatchups).map(Number));
  let future=Object.keys(allMatchups).map(Number).filter(w=>w>currentWeek);
  let baselines={};Object.values(teams).forEach(t=>{let s=teamStats[t.id];let mean=s.ppg||60;let scores=s.scores;let std=20;if(scores.length>1){let mu=mean;let variance=scores.reduce((a,v)=>a+Math.pow(v-mu,2),0)/scores.length;std=Math.sqrt(variance);}baselines[t.id]={mean,std}});
  for(let sim=0;sim<sims;sim++){
    let wins={};Object.keys(teams).forEach(id=>wins[id]=teamStats[id].wins);
    for(let w of future){
      let pairs=[];(allMatchups[w]||[]).forEach(m=>{if(m.home_id!==undefined)pairs.push([m.home_id,m.away_id]);});
      for(let [h,a] of pairs){let hs=gaussian(baselines[h].mean,baselines[h].std);let as=gaussian(baselines[a].mean,baselines[a].std);if(hs>as)wins[h]++;else wins[a]++;}
    }
    let playoffSpots=settings.playoff_teams||4;
    let ranking=Object.entries(wins).sort((a,b)=>b[1]-a[1]);
    ranking.slice(0,playoffSpots).forEach(r=>playoffCounts[r[0]]++);
  }
  let res=Object.entries(playoffCounts).map(([id,c])=>({team:teams[id],odds:(c/sims*100).toFixed(1)}));
  res.sort((a,b)=>b.odds-a.odds);
  return res;
}

// Hook up button
const runBtn=document.getElementById("run-sim");
runBtn.addEventListener("click",async()=>{
  runBtn.disabled=true;runBtn.textContent="Running…";
  let sims=Number(document.getElementById("sim-count").value)||1000;
  let results=await simulate(sims);
  let div=document.getElementById("playoff-results");div.innerHTML="";
  results.forEach(r=>{div.innerHTML+=`<div class='flex justify-between'><span>${r.team.teamName}</span><span>${r.odds}%</span></div>`});
  runBtn.disabled=false;runBtn.textContent="Run Monte Carlo";
});

init();
</script>
</body>
</html>
